upstream cumplo_production {
        server 127.0.0.1:4000;
        server 127.0.0.1:4001;
        server 127.0.0.1:4002;
        server 127.0.0.1:4003;
        server 127.0.0.1:4004;
        server 127.0.0.1:4005;
}

upstream cumplo_blog {
        server 69.195.114.21;
}

server {
	server_name blog.cumplo.cl;
	listen 80;
        location / { 
		rewrite ^/$ https://cumplo.cl/blog/;
		rewrite ^/.*/.*/.*/(.*)/$ https://cumplo.cl/$1/;
		rewrite ^/.*/.*/.*/(.*)$ https://cumplo.cl/$1;
        }
}	
server {
            listen   80;
            server_name  cumplo.cl www.cumplo.cl *.cumplo.cl;
	    location /robots.txt {
		root /www/public_html/robotdisallow;
	    }
	    location / {
            	#rewrite ^ https://cumplo.cl/;
		rewrite ^(.*) https://cumplo.cl$1;
	    }
}

server {
            listen   443;
            ssl on;
            ssl_certificate /etc/pki/tls/certs/cumplo/public/wildcard.cumplo.cl.crt;
            ssl_certificate_key /etc/pki/tls/certs/cumplo/private/wildcard.cumplo.cl.key;

            server_name cumplo.cl;

            access_log /www/public_html/cumplo.cl/log/access.log;
            error_log /www/public_html/cumplo.cl/log/error.log;

            location / {
			  rewrite ^/users/(.*) 		https://secure.cumplo.cl/users/$1;
                          rewrite ^/pages/invest        https://cumplo.cl/como-funciona/;
                          rewrite ^/pages/how_to_invest https://cumplo.cl/como-funciona/;
                          rewrite ^/pages/request_for_funds     https://cumplo.cl/como-funciona/;
                          rewrite ^/pages/how_to_request        https://cumplo.cl/como-funciona/;
                          rewrite ^/pages/what  	https://cumplo.cl/que-es-cumplo/;
                          rewrite ^/pages/credits       https://cumplo.cl/como-funciona/caracteristicas-de-los-creditos-de-consumo/;
                          rewrite ^/pages/simple        https://cumplo.cl/que-es-cumplo/;
                          rewrite ^/pages/p2p   	https://cumplo.cl/que-es-cumplo/creditos-persona-a-persona-en-el-mundo/;
                          rewrite ^/pages/who   	https://cumplo.cl/quienes-somos/;
                          rewrite ^/pages/mision        https://cumplo.cl/quienes-somos/;
                          rewrite ^/pages/team  	https://cumplo.cl/quienes-somos/equipo/;
                          rewrite ^/pages/contact       https://cumplo.cl/contacto/;
                          rewrite ^/pages/faq   	https://cumplo.cl/preguntas-frecuentes/;
                          rewrite ^/pages/what_cumplo   https://cumplo.cl/que-es-cumplo/;
                          rewrite ^/pages/why_cumplo    https://cumplo.cl/que-es-cumplo/;
                          rewrite ^/pages/who_can_join  https://cumplo.cl/como-funciona/requisitos-para-participar/;
                          rewrite ^/pages/who_faq       https://cumplo.cl/quienes-somos/;
                          rewrite ^/pages/how_it_works  https://cumplo.cl/como-funciona/;
                          rewrite ^/pages/commission    https://cumplo.cl/como-funciona/tarifas/;
                          rewrite ^/pages/requests      https://cumplo.cl/preguntas-frecuentes/;
                          rewrite ^/pages/investors     https://cumplo.cl/preguntas-frecuentes/;
                          rewrite ^/pages/requesters    https://cumplo.cl/preguntas-frecuentes/;
                          rewrite ^/pages/remates       https://cumplo.cl/preguntas-frecuentes/;
                          rewrite ^/pages/information   https://cumplo.cl/preguntas-frecuentes/;
                          rewrite ^/pages/legal 	https://cumplo.cl/preguntas-frecuentes/;
			  rewrite ^/mandates/49		https://cumplo.cl/terminos-y-condiciones;
			  rewrite ^/funding_requests$	https://secure.cumplo.cl/funding_requests;
			  rewrite ^/funding_requests/(.*)$	https://secure.cumplo.cl/funding_requests/$1;
			  rewrite ^/investments/384/new(.*)$	https://secure.cumplo.cl/funding_requests/691$1;	
			
                          proxy_set_header X-Real-IP  $remote_addr;
                          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                          proxy_set_header X_FORWARDED_PROTO https;
                          proxy_set_header Host $http_host;
                          proxy_redirect off;
			  proxy_read_timeout 120s;
			  proxy_connect_timeout 120s;
			  proxy_pass http://cumplo_blog/;
            }
}

server {
            listen   443;
            ssl on;
            ssl_certificate /etc/pki/tls/certs/cumplo/public/wildcard.cumplo.cl.crt;
            ssl_certificate_key /etc/pki/tls/certs/cumplo/private/wildcard.cumplo.cl.key;

            server_name secure.cumplo.cl;

            access_log /www/public_html/cumplo.cl/log/access.log;
            error_log /www/public_html/cumplo.cl/log/error.log;

            root   /www/public_html/cumplo.cl/public/;
            index  index.html;

            location / {
                          proxy_set_header  X-Real-IP  $remote_addr;
                          proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
                          proxy_set_header X_FORWARDED_PROTO https;
                          proxy_set_header Host $http_host;
                          proxy_redirect off;
			  error_page 502 = /502.html;				

                          if (-f $request_filename/index.html) {
                                           rewrite (.*) $1/index.html break;
                          }

                          if (-f $request_filename.html) {
                                           rewrite (.*) $1.html break;
                          }

                          if (!-f $request_filename) {
                                           proxy_pass http://cumplo_production;
                                           break;
                          }
            }
	    
            location = /502.html {
		root /www/public_html/cumplo.cl/public;
	    } 
}

